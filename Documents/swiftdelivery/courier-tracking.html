<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸšš Live Courier Tracking - SwiftDelivery</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    .header p {
      font-size: 16px;
      opacity: 0.9;
    }
    .content {
      padding: 30px;
    }
    .search-section {
      margin-bottom: 30px;
    }
    .search-form {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    input[type="text"] {
      flex: 1;
      padding: 12px 15px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #4f46e5;
    }
    button {
      padding: 12px 24px;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #4338ca;
    }
    button:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
    }
    #courierMap {
      height: 500px;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .info-section {
      display: none;
      margin-top: 30px;
    }
    .info-section.active {
      display: block;
    }
    .info-card {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid #4f46e5;
    }
    .info-card h3 {
      margin: 0 0 15px 0;
      color: #1f2937;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }
    .info-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .info-item strong {
      color: #4f46e5;
      display: block;
      margin-bottom: 5px;
    }
    .info-item span {
      color: #6b7280;
      font-size: 14px;
    }
    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 5px;
    }
    .status-active {
      background: #dcfce7;
      color: #166534;
    }
    .error-message {
      color: #dc2626;
      padding: 15px;
      background: #fee2e2;
      border-radius: 8px;
      display: none;
      margin-bottom: 15px;
    }
    .error-message.show {
      display: block;
    }
    .success-message {
      color: #059669;
      padding: 15px;
      background: #d1fae5;
      border-radius: 8px;
      display: none;
      margin-bottom: 15px;
    }
    .success-message.show {
      display: block;
    }
    .clear-btn {
      background: #ef4444;
      margin-top: 15px;
    }
    .clear-btn:hover {
      background: #dc2626;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.5); }
      50% { box-shadow: 0 0 0 8px rgba(255, 107, 107, 0.2); }
    }
    .animated-courier-icon { animation: pulse 1.5s infinite; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸšš Live Courier Tracking</h1>
      <p>Real-time package delivery tracking with animated courier movement</p>
    </div>

    <div class="content">
      <div class="search-section">
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        <form id="courierTrackingForm" class="search-form">
          <input type="text" id="courierTrackingId" placeholder="Enter Tracking ID (e.g., SWIFT-1234567890-ABCDE)" required />
          <button type="submit">Track Courier</button>
        </form>
      </div>

      <div id="courierMap"></div>

      <div class="info-section" id="courierInfo">
        <div class="info-card">
          <h3>ðŸ“¦ Package Details</h3>
          <div class="info-grid">
            <div class="info-item">
              <strong>Tracking ID</strong>
              <span id="infoTrackingId">-</span>
            </div>
            <div class="info-item">
              <strong>Status</strong>
              <span id="infoStatus">-</span>
              <div id="statusBadge"></div>
            </div>
            <div class="info-item">
              <strong>Recipient</strong>
              <span id="infoRecipient">-</span>
            </div>
            <div class="info-item">
              <strong>Email</strong>
              <span id="infoEmail">-</span>
            </div>
            <div class="info-item">
              <strong>Location</strong>
              <span id="infoLocation">-</span>
            </div>
            <div class="info-item">
              <strong>Last Updated</strong>
              <span id="infoUpdated">-</span>
            </div>
          </div>
          <button class="clear-btn" onclick="clearTracking()">Clear Search</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script>
    const API_BASE_URL = 'http://localhost:5000';
    let courierMap = null;
    let courierMarker = null;
    let animatedMarker = null;
    let courierAnimationInterval = null;

    function initCourierMap() {
      if (courierMap) return;
      
      courierMap = L.map('courierMap').setView([6.5244, 3.3792], 11);
      
      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19,
        name: 'Street Map'
      });
      
      const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Â© Esri',
        maxZoom: 18,
        name: 'Satellite'
      });
      
      osm.addTo(courierMap);
      L.control.layers({ 'Street Map': osm, 'Satellite': satellite }).addTo(courierMap);
    }

    function getMarkerIcon(status) {
      const colorMap = {
        'Pending Pickup': '#f59e0b',
        'Pickup Assigned': '#3b82f6',
        'Pickup Accepted': '#10b981',
        'Enroute to Facility': '#8b5cf6',
        'Arrived at Hub or Facility': '#6366f1',
        'In Transit': '#06b6d4',
        'Out for Delivery': '#f97316',
        'Delivered': '#22c55e',
        'Awaiting Receipt': '#14b8a6',
        'Delivery Failed': '#ef4444',
        'Returned to Sender': '#64748b'
      };
      const color = colorMap[status] || '#9ca3af';
      
      return L.divIcon({
        html: `<div style="background-color: ${color}; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; font-size: 16px;">ðŸ“¦</div>`,
        iconSize: [36, 36]
      });
    }

    function getCourierIcon() {
      return L.divIcon({
        html: `<div style="background-color: #ff6b6b; width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 3px #ff6b6b, 0 2px 6px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 14px; animation: pulse 1.5s infinite;">ðŸšš</div>`,
        iconSize: [32, 32],
        className: 'animated-courier-icon'
      });
    }

    function animateCourierMovement(location) {
      if (courierAnimationInterval) clearInterval(courierAnimationInterval);
      if (animatedMarker) courierMap.removeLayer(animatedMarker);
      
      const centerLat = location.lat;
      const centerLng = location.lng;
      const radius = 0.005;
      let angle = 0;
      
      animatedMarker = L.marker([centerLat, centerLng], { 
        icon: getCourierIcon(), 
        zIndexOffset: 1000 
      }).addTo(courierMap);
      
      animatedMarker.bindPopup('<div style="font-size: 12px; text-align: center;"><strong>ðŸšš Courier En Route</strong><br/><span style="color: #ff6b6b;">Moving to delivery location</span></div>');
      
      courierAnimationInterval = setInterval(() => {
        angle = (angle + 2) % 360;
        const rad = (angle * Math.PI) / 180;
        const newLat = centerLat + radius * Math.cos(rad);
        const newLng = centerLng + radius * Math.sin(rad);
        animatedMarker.setLatLng([newLat, newLng]);
      }, 100);
    }

    function showMessage(type, message) {
      const errorEl = document.getElementById('errorMessage');
      const successEl = document.getElementById('successMessage');
      
      if (type === 'error') {
        errorEl.textContent = message;
        errorEl.classList.add('show');
        successEl.classList.remove('show');
      } else {
        successEl.textContent = message;
        successEl.classList.add('show');
        errorEl.classList.remove('show');
      }
    }

    document.getElementById('courierTrackingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const trackingId = document.getElementById('courierTrackingId').value.trim();
      if (!trackingId) return;
      
      try {
        initCourierMap();
        
        const response = await fetch(`${API_BASE_URL}/api/tracking/${trackingId}`);
        if (!response.ok) throw new Error('Tracking ID not found');
        
        const data = await response.json();
        
        if (courierMarker) courierMap.removeLayer(courierMarker);
        
        const location = [data.location.lat, data.location.lng];
        courierMarker = L.marker(location, { icon: getMarkerIcon(data.status) }).addTo(courierMap);
        courierMarker.bindPopup(`<strong>${data.user.fullName}</strong><br/>Status: ${data.status}<br/>Tracking: ${data.trackingId}`).openPopup();
        
        courierMap.setView(location, 14);
        
        document.getElementById('infoTrackingId').textContent = data.trackingId;
        document.getElementById('infoStatus').textContent = data.status;
        document.getElementById('infoRecipient').textContent = data.user.fullName;
        document.getElementById('infoEmail').textContent = data.user.email;
        document.getElementById('infoLocation').textContent = `${data.location.lat.toFixed(4)}, ${data.location.lng.toFixed(4)}`;
        document.getElementById('infoUpdated').textContent = new Date(data.updatedAt).toLocaleString();
        
        const activeStatuses = ['Out for Delivery', 'In Transit', 'Enroute to Facility'];
        if (activeStatuses.includes(data.status)) {
          document.getElementById('statusBadge').innerHTML = '<span class="status-badge status-active">ðŸšš Active Delivery</span>';
          setTimeout(() => animateCourierMovement(data.location), 500);
        } else if (data.status === 'Delivered') {
          document.getElementById('statusBadge').innerHTML = '<span class="status-badge" style="background: #d1d5db; color: #374151;">âœ“ Delivered</span>';
        } else {
          document.getElementById('statusBadge').innerHTML = '';
        }
        
        document.getElementById('courierInfo').classList.add('active');
        document.getElementById('courierTrackingId').value = '';
        showMessage('success', 'âœ“ Tracking information loaded!');
      } catch (err) {
        showMessage('error', 'Error: ' + err.message);
        document.getElementById('courierInfo').classList.remove('active');
      }
    });

    function clearTracking() {
      document.getElementById('courierTrackingId').value = '';
      document.getElementById('courierInfo').classList.remove('active');
      if (courierMarker) courierMap.removeLayer(courierMarker);
      if (animatedMarker) courierMap.removeLayer(animatedMarker);
      if (courierAnimationInterval) clearInterval(courierAnimationInterval);
      courierMap.setView([6.5244, 3.3792], 11);
      document.getElementById('errorMessage').classList.remove('show');
      document.getElementById('successMessage').classList.remove('show');
    }

    initCourierMap();
  </script>
</body>
</html>
